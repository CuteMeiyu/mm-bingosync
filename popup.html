<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        .board-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-gap: 1px;
            background-color: black;
        }

        .scoreboard {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap-reverse;
            position: fixed;
            bottom: 0;
            background-color: #7f7f7f;
            width: 100vw;
        }

        .scoreboard-item {
            display: inline-block;
            padding: 2px;
            padding-inline: 10px;
        }

        .cell {
            position: relative;
            background-color: #2c2c2c;
            border: 1px solid #666;
            cursor: pointer;
            color: #fff;
            -webkit-user-select: none;
            user-select: none;
        }

        .diff1 {
            border: 2px solid rgb(255, 255, 0);
        }

        .diff2 {
            border: 2px solid rgb(255, 0, 0);
        }

        .diff3 {
            border: 2px solid rgb(192, 0, 255);
        }

        .cell-text {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 90%;
            transform: translate(-50%, -50%);
            text-align: center;
            word-break: break-all;
        }

        .cell-game {
            position: absolute;
            width: 100%;
            bottom: 0%;
            text-align: center;
            word-break: break-all;
        }

        .cell-info {
            position: absolute;
            text-align: center;
            word-break: break-all;
        }

        .cell-password {
            position: absolute;
            right: 0%;
            text-align: center;
            word-break: break-all;
        }

        .cell-star {
            position: absolute;
            bottom: 0%;
            text-align: center;
            word-break: break-all;
            opacity: 0;
        }

        .tooltip {
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 4px;
            position: absolute;
            z-index: 1;
            padding: 4px;

            opacity: 0;
            transform: scale(0.0);
        }

        .show {
            opacity: 1;
            transform: scale(1.0);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 50px;
            height: 50px;
            animation: spin 1s ease-in-out infinite;
        }

        .spinner-text {
            color: rgb(255, 255, 255);
        }

        @keyframes spin {
            0% {
                transform: rotate(360deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }
    </style>
</head>

<body>
    <div class="modal-overlay" id="modal-overlay">
        <div class="spinner"></div>
        <span class="spinner-text" id="spinner-text">正在加载...</span>
    </div>
    <span id="tooltip" class="tooltip"></span>
    <div id="board" class="board-container">
        <div id="cell_0_0" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_0_1" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_0_2" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_0_3" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_0_4" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_1_0" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_1_1" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_1_2" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_1_3" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_1_4" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_2_0" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_2_1" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_2_2" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_2_3" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_2_4" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_3_0" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_3_1" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_3_2" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_3_3" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_3_4" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_4_0" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_4_1" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_4_2" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_4_3" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
        <div id="cell_4_4" class="cell" onclick="onCellClick(event)">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
            <span class="cell-star">★</span>
        </div>
    </div>
    <div class="scoreboard" id="scoreboard" onclick="document.getElementById('color-picker').click();"></div>
    <input type="color" style="display: none;" id="color-picker" input="onColorChange" value="#000000"></input>

    <script src='https://cdn.scaledrone.com/scaledrone-lite.min.js'></script>
    <script>
        function showSpinner(text) {
            let modalOverlay = document.getElementById('modal-overlay');
            let spinnerText = document.getElementById('spinner-text');
            spinnerText.innerHTML = text;
            modalOverlay.style.display = 'flex';
        }

        function hideSpinner() {
            let modalOverlay = document.getElementById('modal-overlay');
            let spinnerText = document.getElementById('spinner-text');
            spinnerText.innerHTML = "";
            modalOverlay.style.display = 'none';
        }
    </script>
    <script>
        const queryParams = new URLSearchParams(window.location.search);
        const syncTimeout = 10000;

        var playerName = queryParams.get('player');
        var roomName = queryParams.get('room');
        var playerColors = {};

        var connected = false;
        var sync = false;
        var drone;
        var room;
        var historyEvents = [];
        var syncMemberIds = [];
        var syncTimer = 0;
        var syncSource;

        if (roomName != null) {
            showSpinner("正在连接服务器...");
            roomName = `observable-${roomName}`
            drone = new Scaledrone('DO4LDJ74Bp80Kcso');
            room = drone.subscribe(roomName);
            registerEvents();
        } else {
            hideSpinner();
        }

        function sendSyncData(cell, player, sendPlayerColors = false, sendHistoryEvents = false) {
            let message = {}
            if (cell != null) {
                message.cell = cell;
            }
            if (player != null) {
                message.player = player;
            }
            if (sendPlayerColors) {
                message.players = playerColors;
            }
            if (sendHistoryEvents) {
                message.history = historyEvents;
                message.sync = sync;
            }
            drone.publish({
                room: roomName,
                message: message
            })
        }

        function sendSyncRequest(sourceId) {
            syncSource = sourceId;
            drone.publish({
                room: roomName,
                message: { syncSource: sourceId }
            })
        }

        function registerEvents() {
            drone.on('open', error => {
                if (error) {
                    return console.error(error);
                }
                console.log('Connected to server');
            });

            room.on('open', error => {
                if (error) {
                    return console.error(error);
                }
                console.log('Connected to room');
                connected = true;
                hideSpinner();
            });

            function askFromSyncMembers(timeout) {
                if (sync) {
                    return;
                }
                while (syncMemberIds.length > 0) {
                    let memberId = syncMemberIds.pop();
                    if (memberId === drone.clientId) {
                        continue;
                    }
                    sendSyncRequest(memberId);
                    console.log(`Sent sync request to: ${memberId}`);
                    clearTimeout(syncTimer);
                    syncTimer = setTimeout(askFromSyncMembers, timeout, timeout);
                    return;
                }
                console.log("No sync member");
                sync = true;
            }

            room.on('members', function (members) {
                console.log("Members", members);
                syncMemberIds = members.map(member => member.id);
                askFromSyncMembers(syncTimeout);
            });

            room.on('member_leave', function (member) {
                console.log("Member left", member);
                if (syncMemberIds.includes(member.id)) {
                    syncMemberIds.splice(syncMemberIds.indexOf(member.id), 1);
                }
            });

            function historyIncludes(event) {
                for (let history of historyEvents) {
                    if (history.id === event.id) {
                        return true;
                    }
                }
                return false;
            }

            function mergeHistory(events) {
                for (let event of events) {
                    if (!historyIncludes(event)) {
                        historyEvents.push(event);
                        toggleCell(event.cell, event.player);
                    }
                }
            }

            room.on('message', message => {
                console.log("Message", message);
                if (message.data.players !== undefined) {
                    for (let [player, color] of Object.entries(message.data.players)) {
                        playerColors[player] = color;
                    }
                }
                if (message.data.player != null && message.data.cell != null) {
                    toggleCell(message.data.cell, message.data.player);
                    historyEvents.push({
                        id: message.id,
                        cell: message.data.cell,
                        player: message.data.player
                    });
                }
                if (message.data.history !== undefined) {
                    mergeHistory(message.data.history);
                }
                if (message.data.sync === true) {
                    sync = true;
                    if (!syncMemberIds.includes(message.member.id)) {
                        syncMemberIds.push(message.member.id);
                    }
                }
                if (message.data.syncSource === drone.clientId) {
                    sendSyncData(null, null, true, true);
                    console.log(`Answered sync request from ${message.member.id}`);
                    return;
                }
            });

            drone.on('error', error => {
                console.error('Error with connection:', error);
            });
            drone.on('close', event => {
                console.log('Connection closed:', event);
            });

            drone.on('disconnect', () => {
                console.log('Connection lost');
                showSpinner("正在重连...");
                connected = false;
                sync = false;
            });
            drone.on('reconnect', () => {
                console.log('Connection reestablished');
                hideSpinner();
                connected = true;
                sync = false;
                askFromSyncMembers(syncTimeout);
            });
        }

        function onCellClick(event) {
            if (event.target.closest(".cell-info,.cell-password") !== null) {
                return;
            }
            let cell = event.target.closest(".cell");
            let colorPicker = document.getElementById("color-picker");
            if (playerName == undefined) {
                playerName = "Player";
            }
            playerColors[playerName] = colorPicker.value;
            if (playerColors[playerName] === "#000000") {
                document.getElementById("color-picker").click()
                return;
            }
            if (roomName == null) {
                toggleCell(cell.id, playerName);
                return;
            }
            if (!connected) {
                return;
            }
            sendSyncData(cell.id, playerName, true, true);
        }
    </script>

    <script>
        function updateBoardColors() {
            for (let cell of document.querySelectorAll(".cell")) {
                if (cell.players != undefined) {
                    updateCellColors(cell.id);
                }
            }
        }

        function updateCellColors(id) {
            let element = document.getElementById(id);
            let colors = [];
            for (let player of element.players) {
                if (playerColors[player] !== undefined) {
                    colors.push(playerColors[player]);
                } else {
                    colors.push("#000000");
                }
            }
            if (colors.length == 0) {
                element.style.background = null;
            }
            let width = element.offsetWidth;
            let height = element.offsetHeight;
            let degree = (Math.atan(height / width) * 180.0 / Math.PI + 90.0) * 0.5;
            let gradient = `linear-gradient(${Math.floor(degree)}deg`;
            colors.forEach(function (color, index) {
                let start = (100 / colors.length) * index;
                let end = (100 / colors.length) * (index + 1);
                gradient += `, ${color} ${start}%, ${color} ${end}%`;
            });
            gradient += ')';
            element.style.background = gradient;
        }

        function toggleCell(id, player) {
            let cell = document.getElementById(id);
            if (cell.players === undefined) {
                cell.players = [player];
            } else if (cell.players.indexOf(player) == -1) {
                cell.players.push(player);
            } else {
                cell.players.splice(cell.players.indexOf(player), 1);
            }
            cell.players.sort();
            updateBoardColors();
            updateScoreboard();
        }
    </script>
    <script>
        function updateScoreboard() {
            let scoreboard = document.getElementById("scoreboard");
            scoreboard.innerHTML = "";
            let scores = {};
            for (let cell of document.querySelectorAll(".cell")) {
                if (cell.players === undefined) {
                    continue;
                }
                for (let player of cell.players) {
                    if (scores[player] === undefined) {
                        scores[player] = 1;
                    } else {
                        scores[player] += 1;
                    }
                }
            }
            for (let [player, color] of Object.entries(playerColors)) {
                let item = document.createElement("div");
                item.classList.add("scoreboard-item");
                item.style.color = color;
                let score = scores[player];
                item.innerHTML = `${player}: ${score == undefined ? 0 : score}`;
                scoreboard.appendChild(item);
            }
            if (scoreboard.childNodes.length == 0) {
                let item = document.createElement("div");
                item.classList.add("scoreboard-item");
                item.style.color = "#ffffff";
                item.innerText = "记分板"
                scoreboard.appendChild(item);
            }
            onResize();
        }
    </script>
    <script>
        var data;

        function resizeBoardToFitWindow() {
            let board = document.getElementById("board");
            let w = window.innerWidth;
            let h = window.innerHeight;
            let scoreboard = document.getElementById("scoreboard");
            let scoreboardHeight = scoreboard.offsetHeight;
            h = Math.min(h, h - scoreboardHeight);
            if (w / h > 1.2) {
                w = h * 1.2;
            } else if (h / w > 1.2) {
                h = w * 1.2;
            }
            board.style.width = w + "px";
            board.style.height = h + "px";
        }

        function resizeTextToFitCell() {
            let cellTexts = document.querySelectorAll('.cell-text');
            cellTexts.forEach(function (cellText) {
                let cell = cellText.closest('.cell');
                let cellGame = cell.querySelector('.cell-game');
                let cellWidth = cell.offsetWidth;
                let cellHeight = cell.offsetHeight;
                let fontSize = 100;
                let textWidth, textHeight;
                do {
                    cellText.style.fontSize = fontSize + '%';
                    cellGame.style.fontSize = Math.max(Math.floor(fontSize * 0.5), 1) + '%';
                    textWidth = cellText.offsetWidth;
                    textHeight = cellText.offsetHeight;
                    fontSize -= 1;
                } while ((textWidth > cellWidth || textHeight > cellHeight * 0.8) && fontSize > 0);
            });
        }

        function onResize() {
            resizeBoardToFitWindow();
            resizeTextToFitCell();
        }

        window.addEventListener('resize', function () {
            onResize();
        });

        function onMouseIn(event) {
            let tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = event.currentTarget.dataset.tooltip.replace(/\n/g, '<br />');
            tooltip.style.left = "0px";
            tooltip.style.top = "0px";

            let newX = event.clientX + 15;
            let newY = event.clientY + 30;
            let vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
            let vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);

            if (newX + tooltip.offsetWidth > vw) {
                newX = Math.max(0, vw - tooltip.offsetWidth);
            }
            tooltip.style.left = newX + "px";

            if (newY + tooltip.offsetHeight > vh) {
                newY = event.clientY - tooltip.offsetHeight - 15;
            }
            tooltip.style.top = newY + "px";

            tooltip.classList.add('show');
        }

        function onMouseOut(event) {
            let tooltip = document.getElementById('tooltip');
            tooltip.classList.remove('show');
            tooltip.innerHTML = "";
        }

        for (let cellInfo of document.querySelectorAll('.cell-info')) {
            cellInfo.addEventListener('mousemove', onMouseIn);
            cellInfo.addEventListener('mouseout', onMouseOut);
        }

        for (let cellPassword of document.querySelectorAll('.cell-password')) {
            cellPassword.addEventListener('mousemove', onMouseIn);
            cellPassword.addEventListener('mouseout', onMouseOut);
        }

        function onContextMenu(event) {
            event.preventDefault();
            let cell = event.target.closest(".cell");
            let star = cell.querySelector(".cell-star");
            star.classList.toggle("show");
        }

        for (let cell of document.querySelectorAll('.cell')) {
            cell.addEventListener('contextmenu', onContextMenu);
        }

        window.addEventListener('DOMContentLoaded', function () {
            fetch('data.json?' + new Date().getTime())
                .then(response => response.json())
                .then(d => {
                    data = d;
                    let indexes = queryParams.get('id').split(',').map(function (item) {
                        return parseInt(item);
                    });
                    let showGames = false;
                    let previousGame = null;
                    for (let i = 0; i < indexes.length; i++) {
                        let goal = data[indexes[i]];
                        let cell = document.getElementById('cell_' + Math.floor(i / 5) + '_' + i % 5)
                        if (goal.diff > 0) {
                            cell.classList.add('diff' + goal.diff);
                        }

                        let cellText = cell.querySelector(".cell-text");
                        cellText.innerHTML = goal.name;

                        let cellGame = cell.querySelector(".cell-game");
                        if (goal.games !== undefined && goal.games.length > 0) {
                            cellGame.innerHTML = "MM" + goal.games.join(',');
                        } else {
                            cellGame.innerHTML = "";
                        }
                        if (!showGames && previousGame != null && previousGame != cellGame.innerHTML) {
                            showGames = true;
                        }
                        if (previousGame == null) {
                            previousGame = cellGame.innerHTML;
                        }

                        let cellInfo = cell.querySelector(".cell-info");
                        if (goal.notes != undefined) {
                            cellInfo.innerHTML = "<img src='img/info.png'/>";
                            cellInfo.dataset.tooltip = goal.notes.replace(/[“”]/g, '"').replace(/[‘’]/g, "'");
                        }

                        let cellPassword = cell.querySelector(".cell-password");
                        if (goal.password != undefined) {
                            cellPassword.innerHTML = "<img src='img/pw.png'/>";
                            if (goal.password == "y") {
                                cellPassword.dataset.tooltip = "可以从城堡1开始"
                            } else {
                                cellPassword.dataset.tooltip = goal.password.replace(/[“”]/g, '"').replace(/[‘’]/g, "'")
                            }
                        }
                    }
                    for (let img of document.querySelectorAll("img")) {
                        img.alt = "[图片]";
                    }
                    if (!showGames) {
                        for (let cellGame of document.querySelectorAll('.cell-game')) {
                            cellGame.style.display = 'none';
                        }
                    }
                    updateScoreboard();
                    // onResize();
                });
        });
    </script>
</body>

</html>