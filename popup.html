<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        .board-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-gap: 1px;
            width: min(100vw, 120vh);
            height: min(100vh, 120vw);
            background-color: black;
        }

        .cell {
            position: relative;
            background-color: #2c2c2c;
            border: 1px solid #666;
            cursor: pointer;
            color: #fff;
        }

        .diff1 {
            border: 2px solid rgb(255, 255, 0);
        }

        .diff2 {
            border: 2px solid rgb(255, 0, 0);
        }

        .diff3 {
            border: 2px solid rgb(192, 0, 255);
        }

        .cell-text {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 90%;
            transform: translate(-50%, -50%);
            text-align: center;
            word-break: break-all;
            user-select: none;
        }

        .cell-game {
            position: absolute;
            top: 90%;
            left: 50%;
            width: 90%;
            transform: translate(-50%, -50%);
            text-align: center;
            word-break: break-all;
            user-select: none;
        }

        .cell-info {
            position: absolute;
            text-align: center;
            word-break: break-all;
            user-select: none;
        }

        .cell-password {
            position: absolute;
            right: 0%;
            text-align: center;
            word-break: break-all;
            user-select: none;
        }

        .tooltip {
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 4px;
            position: absolute;
            z-index: 1;
            opacity: 0;
            padding: 4px;
        }

        .show {
            opacity: 1;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 50px;
            height: 50px;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(360deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }
    </style>
</head>

<body>
    <div class="modal-overlay" id="modal-overlay">
        <div class="spinner"></div>
    </div>
    <span id="tooltip" class="tooltip"></span>
    <div id="board" class="board-container">
        <div id="cell_0_0" class="cell" onclick="onCellClick('cell_0_0')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_0_1" class="cell" onclick="onCellClick('cell_0_1')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_0_2" class="cell" onclick="onCellClick('cell_0_2')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_0_3" class="cell" onclick="onCellClick('cell_0_3')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_0_4" class="cell" onclick="onCellClick('cell_0_4')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_1_0" class="cell" onclick="onCellClick('cell_1_0')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_1_1" class="cell" onclick="onCellClick('cell_1_1')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_1_2" class="cell" onclick="onCellClick('cell_1_2')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_1_3" class="cell" onclick="onCellClick('cell_1_3')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_1_4" class="cell" onclick="onCellClick('cell_1_4')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_2_0" class="cell" onclick="onCellClick('cell_2_0')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_2_1" class="cell" onclick="onCellClick('cell_2_1')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_2_2" class="cell" onclick="onCellClick('cell_2_2')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_2_3" class="cell" onclick="onCellClick('cell_2_3')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_2_4" class="cell" onclick="onCellClick('cell_2_4')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_3_0" class="cell" onclick="onCellClick('cell_3_0')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_3_1" class="cell" onclick="onCellClick('cell_3_1')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_3_2" class="cell" onclick="onCellClick('cell_3_2')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_3_3" class="cell" onclick="onCellClick('cell_3_3')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_3_4" class="cell" onclick="onCellClick('cell_3_4')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_4_0" class="cell" onclick="onCellClick('cell_4_0')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_4_1" class="cell" onclick="onCellClick('cell_4_1')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_4_2" class="cell" onclick="onCellClick('cell_4_2')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_4_3" class="cell" onclick="onCellClick('cell_4_3')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_4_4" class="cell" onclick="onCellClick('cell_4_4')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
    </div>

    <script src='https://cdn.scaledrone.com/scaledrone-lite.min.js'></script>
    <script>
        const queryParams = new URLSearchParams(window.location.search);
        const syncTimeout = 10000;
        var playerColor = "#" + queryParams.get('color');
        var roomName = queryParams.get('room');
        var connected = false;
        var sync = false;
        var drone;
        var room;
        var historyMessages = [];
        var syncMembers = [];
        var syncTimer;
        var syncId;

        if (roomName != null) {
            roomName = `observable-${roomName}`
            drone = new Scaledrone('DO4LDJ74Bp80Kcso');
            room = drone.subscribe(roomName);
            registerEvents();
        } else {
            let modalOverlay = document.getElementById('modal-overlay');
            modalOverlay.style.display = 'none';
        }

        function registerEvents() {
            drone.on('open', error => {
                if (error) {
                    return console.error(error);
                }
                console.log('Connected to server');
            });

            room.on('open', error => {
                if (error) {
                    console.error(error);
                } else {
                    console.log('Connected to room');
                    connected = true;
                    let modalOverlay = document.getElementById('modal-overlay');
                    modalOverlay.style.display = 'none';
                }
            });

            function askForSync(timeout) {
                while (syncMembers.length > 0) {
                    member = syncMembers.pop();
                    if (member.id === drone.clientId) {
                        continue;
                    }
                    syncId = member.id;
                    drone.publish({
                        room: roomName,
                        message: { syncId: syncId }
                    });
                    console.log(`Waiting for sync from ${syncId}`);
                    syncTimer = setTimeout(askForSync, timeout, timeout);
                    return;
                }
                console.log("No sync member");
                sync = true;
            }

            room.on('members', function (members) {
                console.log("Members", members);
                syncMembers = members;
                askForSync(syncTimeout);
            });

            room.on('member_leave', function (member) {
                console.log("Member left", member);
                if (syncMembers.includes(member.id)) {
                    syncMembers.splice(syncMembers.indexOf(member.id), 1);
                }
            });

            room.on('message', message => {
                console.log("Message", message);
                if (message.data.color !== undefined) {
                    if (!syncMembers.includes(message.member)) {
                        syncMembers.push(message.member);
                    }
                    historyMessages.push(message);
                    toggleCellColor(message.data.id, message.data.color);
                    return;
                }
                if (message.data.syncId === drone.clientId) {
                    drone.publish({
                        room: roomName,
                        message: {
                            board: sync ? getBoardColors() : null
                        }
                    });
                    console.log(`Answered sync from ${message.member.id}`);
                    return;
                }
                if (message.data.board === undefined || sync || message.member.id !== syncId) {
                    return;
                }
                clearTimeout(syncTimer);
                if (message.data.board === null) {
                    console.log(`Empty sync data from ${message.member.id}`);
                    askForSync(syncTimeout);
                    return;
                }
                sync = true;
                syncMembers = [];
                setBoardColors(message.data.board);
                for (let historyMessage of historyMessages) {
                    if (historyMessage.timestamp < message.timestamp) {
                        continue;
                    }
                    toggleCellColor(historyMessage.data.id, historyMessage.data.color);
                }
                console.log(`Successful sync from ${message.member.id}`);
            });

            drone.on('error', error => {
                console.error('Error with connection:', error);
            });
            drone.on('close', event => {
                console.log('Connection closed:', event);
            });

            drone.on('disconnect', () => {
                console.log('Connection lost');
                let modalOverlay = document.getElementById('modal-overlay');
                modalOverlay.style.display = 'flex';
                connected = false;
                sync = false;
            });
            drone.on('reconnect', () => {
                console.log('Connection reestablished');
                let modalOverlay = document.getElementById('modal-overlay');
                modalOverlay.style.display = 'none';
                connected = true;
                askForSync(syncTimeout);
            });
        }

        function onCellClick(id) {
            if (roomName == null) {
                toggleCellColor(id, playerColor);
                return;
            }
            if (!connected) {
                return;
            }
            let cell = document.getElementById(id);
            drone.publish({
                room: roomName,
                message: {
                    id: id,
                    color: playerColor
                }
            });
        }
    </script>

    <script>
        function setBoardColors(boardColors) {
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    setBackground(`cell_${row}_${col}`, []);
                }
            }
            for (let i = 0; i < boardColors.length; i++) {
                let colors = boardColors[i].colors;
                let id = boardColors[i].id;
                setBackground(id, colors);
            }
        }

        function getBoardColors() {
            let boardColors = [];
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    let id = `cell_${row}_${col}`
                    let cell = document.getElementById(id);
                    let colors = cell.colors;
                    if (colors != undefined && colors.length > 0) {
                        boardColors.push({ id: id, colors: cell.colors });
                    }
                }
            }
            return boardColors;
        }

        function setBackground(id, colors) {
            let element = document.getElementById(id);
            element.colors = colors;
            if (colors.length == 0) {
                element.style.background = null;
            }
            let width = element.offsetWidth;
            let height = element.offsetHeight;
            let degree = (Math.atan(height / width) * 180.0 / Math.PI + 90.0) * 0.5;
            let gradient = `linear-gradient(${Math.floor(degree)}deg`;
            colors.forEach(function (color, index) {
                let start = (100 / colors.length) * index;
                let end = (100 / colors.length) * (index + 1);
                gradient += `, ${color} ${start}%, ${color} ${end}%`;
            });
            gradient += ')';
            element.style.background = gradient;
        }

        function toggleCellColor(id, color) {
            let cell = document.getElementById(id);
            if (cell.colors === undefined) {
                cell.colors = [color];
            } else if (cell.colors.indexOf(color) == -1) {
                cell.colors.push(color);
            } else {
                cell.colors.splice(cell.colors.indexOf(color), 1);
            }
            cell.colors.sort();
            setBackground(id, cell.colors);
        }
    </script>

    <script>
        var data;

        function resizeTextToFitGrid() {
            var cellTexts = document.querySelectorAll('.cell-text');
            cellTexts.forEach(function (cellText) {
                var cell = cellText.closest('.cell');
                var cellGame = cell.querySelector('.cell-game');
                var cellWidth = cell.offsetWidth;
                var cellHeight = cell.offsetHeight;
                var fontSize = 100;
                var textWidth, textHeight;

                do {
                    cellText.style.fontSize = fontSize + '%';
                    cellGame.style.fontSize = Math.max(Math.floor(fontSize * 0.5), 1) + '%';
                    textWidth = cellText.offsetWidth;
                    textHeight = cellText.offsetHeight;
                    fontSize -= 1;
                } while ((textWidth > cellWidth || textHeight > cellHeight * 0.9) && fontSize > 0);
            });
        }

        window.addEventListener('resize', function () {
            resizeTextToFitGrid();
        });

        function onMouseIn(event) {
            let tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = event.currentTarget.dataset.tooltip.replace(/\n/g, '<br />');
            tooltip.style.left = "0px";
            tooltip.style.top = "0px";

            let newX = event.clientX + 15;
            let newY = event.clientY + 30;
            let vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
            let vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);

            if (newX + tooltip.offsetWidth > vw) {
                newX = Math.max(0, vw - tooltip.offsetWidth);
            }
            tooltip.style.left = newX + "px";

            if (newY + tooltip.offsetHeight > vh) {
                newY = event.clientY - tooltip.offsetHeight - 15;
            }
            tooltip.style.top = newY + "px";

            tooltip.classList.add('show');
        }

        function onMouseOut(event) {
            let tooltip = document.getElementById('tooltip');
            tooltip.classList.remove('show');
            tooltip.innerHTML = "";
        }

        for (let cellInfo of document.querySelectorAll('.cell-info')) {
            cellInfo.addEventListener('mousemove', onMouseIn);
            cellInfo.addEventListener('mouseout', onMouseOut);
        }

        for (let cellPassword of document.querySelectorAll('.cell-password')) {
            cellPassword.addEventListener('mousemove', onMouseIn);
            cellPassword.addEventListener('mouseout', onMouseOut);
        }

        window.addEventListener('DOMContentLoaded', function () {
            fetch('data.json?' + new Date().getTime())
                .then(response => response.json())
                .then(d => {
                    data = d;
                    let indexes = queryParams.get('id').split(',').map(function (item) {
                        return parseInt(item);
                    });
                    let showGames = false;
                    let previousGame = null;
                    for (let i = 0; i < indexes.length; i++) {
                        let goal = data[indexes[i]];
                        let cell = document.getElementById('cell_' + Math.floor(i / 5) + '_' + i % 5)
                        if (goal.diff > 0) {
                            cell.classList.add('diff' + goal.diff);
                        }

                        let cellText = cell.querySelector(".cell-text");
                        cellText.innerHTML = goal.name;

                        let cellGame = cell.querySelector(".cell-game");
                        cellGame.innerHTML = "MM" + goal.games.join(',');
                        if (!showGames && previousGame != null && previousGame != cellGame.innerHTML) {
                            showGames = true;
                        }
                        if (previousGame == null) {
                            previousGame = cellGame.innerHTML;
                        }

                        let cellInfo = cell.querySelector(".cell-info");
                        if (goal.notes != undefined) {
                            cellInfo.innerHTML = "<img src='img/info.png'/>";
                            cellInfo.dataset.tooltip = goal.notes.replace(/[“”]/g, '"').replace(/[‘’]/g, "'");
                        }

                        let cellPassword = cell.querySelector(".cell-password");
                        if (goal.password != undefined) {
                            cellPassword.innerHTML = "<img src='img/pw.png'/>";
                            if (goal.password == "y") {
                                cellPassword.dataset.tooltip = "可以从城堡1开始"
                            } else {
                                cellPassword.dataset.tooltip = goal.password.replace(/[“”]/g, '"').replace(/[‘’]/g, "'")
                            }
                        }
                    }
                    if (!showGames) {
                        for (let cellGame of document.querySelectorAll('.cell-game')) {
                            cellGame.style.display = 'none';
                        }
                    }
                    resizeTextToFitGrid();
                });
        });
    </script>
</body>

</html>