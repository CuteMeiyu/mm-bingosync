<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        .board-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-gap: 1px;
            width: min(100vw, 120vh);
            height: min(83vw, 100vh);
            background-color: black;
        }

        .cell {
            position: relative;
            background-color: #2c2c2c;
            border: 1px solid #666;
            cursor: pointer;
            color: #fff;
        }

        .diff1 {
            border: 2px solid rgb(255, 255, 0);
        }

        .diff2 {
            border: 2px solid rgb(255, 0, 0);
        }

        .diff3 {
            border: 2px solid rgb(192, 0, 255);
        }

        .cell-text {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 90%;
            transform: translate(-50%, -50%);
            text-align: center;
            word-break: break-all;
            user-select: none;
        }

        .cell-game {
            position: absolute;
            top: 90%;
            left: 50%;
            width: 90%;
            transform: translate(-50%, -50%);
            text-align: center;
            word-break: break-all;
            user-select: none;
        }

        .cell-info {
            position: absolute;
            text-align: center;
            word-break: break-all;
            user-select: none;
        }

        .cell-password {
            position: absolute;
            right: 0%;
            text-align: center;
            word-break: break-all;
            user-select: none;
        }

        .lit1 {
            background-color: rgb(120, 174, 185) !important;
            color: rgb(0, 0, 0) !important;
        }

        .lit2 {
            background-color: rgb(143, 214, 133) !important;
            color: rgb(0, 0, 0) !important;
        }

        .tooltip {
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 4px;
            position: absolute;
            z-index: 1;
            opacity: 0;
            padding: 4px;
        }

        .show {
            opacity: 1;
        }
    </style>
</head>

<body>
    <span id="tooltip" class="tooltip"></span>
    <div id="board" class="board-container">
        <div id="cell_0_0" class="cell" onclick="onCellClick('cell_0_0')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_0_1" class="cell" onclick="onCellClick('cell_0_1')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_0_2" class="cell" onclick="onCellClick('cell_0_2')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_0_3" class="cell" onclick="onCellClick('cell_0_3')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_0_4" class="cell" onclick="onCellClick('cell_0_4')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_1_0" class="cell" onclick="onCellClick('cell_1_0')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_1_1" class="cell" onclick="onCellClick('cell_1_1')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_1_2" class="cell" onclick="onCellClick('cell_1_2')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_1_3" class="cell" onclick="onCellClick('cell_1_3')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_1_4" class="cell" onclick="onCellClick('cell_1_4')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_2_0" class="cell" onclick="onCellClick('cell_2_0')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_2_1" class="cell" onclick="onCellClick('cell_2_1')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_2_2" class="cell" onclick="onCellClick('cell_2_2')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_2_3" class="cell" onclick="onCellClick('cell_2_3')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_2_4" class="cell" onclick="onCellClick('cell_2_4')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_3_0" class="cell" onclick="onCellClick('cell_3_0')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_3_1" class="cell" onclick="onCellClick('cell_3_1')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_3_2" class="cell" onclick="onCellClick('cell_3_2')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_3_3" class="cell" onclick="onCellClick('cell_3_3')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_3_4" class="cell" onclick="onCellClick('cell_3_4')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_4_0" class="cell" onclick="onCellClick('cell_4_0')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_4_1" class="cell" onclick="onCellClick('cell_4_1')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_4_2" class="cell" onclick="onCellClick('cell_4_2')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_4_3" class="cell" onclick="onCellClick('cell_4_3')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
        <div id="cell_4_4" class="cell" onclick="onCellClick('cell_4_4')">
            <span class="cell-text"></span>
            <span class="cell-game"></span>
            <span class="cell-info"></span>
            <span class="cell-password"></span>
        </div>
    </div>

    <script src='https://cdn.scaledrone.com/scaledrone-lite.min.js'></script>
    <script>
        const queryParams = new URLSearchParams(window.location.search);
        var playerColor = queryParams.get('color');
        var roomName = queryParams.get('room');
        var connected = false;

        const drone = new Scaledrone('DO4LDJ74Bp80Kcso');
        drone.on('open', error => {
            if (error) {
                return console.error(error);
            }
            console.log('Connected to Server');
        });

        const room = drone.subscribe(roomName);
        room.on('open', error => {
            if (error) {
                console.error(error);
            } else {
                console.log('Connected to room');
                connected = true;
            }
        });

        room.on('message', message => {
            console.log(message.data);
            toggleCell(message.data.id, message.data.color);
        });

        drone.on('error', error => {
            console.error('Error with connection:', error);
        });
        drone.on('close', event => {
            console.log('Connection closed:', event);
        });

    </script>

    <script>
        function setBackground(id, colors) {
            let element = document.getElementById(id);
            if (colors.length == 0) {
                element.style.background = null;
            }
            let width = element.offsetWidth;
            let height = element.offsetHeight;
            let degree = (Math.atan(height / width) * 180.0 / Math.PI + 90.0) * 0.5;
            let gradient = `linear-gradient(${Math.floor(degree)}deg`;
            colors.forEach(function (color, index) {
                let start = (100 / colors.length) * index;
                let end = (100 / colors.length) * (index + 1);
                gradient += `, ${color} ${start}%, ${color} ${end}%`;
            });
            gradient += ')';
            element.style.background = gradient;
        }

        function onCellClick(id) {
            if (!connected) {
                return;
            }
            let cell = document.getElementById(id);
            let message = {
                id: id,
                color: playerColor
            }
            drone.publish({
                room: roomName,
                message: message
            });
        }

        function toggleCell(id, color) {
            let cell = document.getElementById(id);
            if (cell.colors === undefined) {
                cell.colors = [color];
            } else if (cell.colors.indexOf(color) == -1) {
                cell.colors.push(color);
            } else {
                cell.colors.splice(cell.colors.indexOf(color), 1);
            }
            cell.colors.sort();
            setBackground(id, cell.colors);
        }
    </script>

    <script>
        var data;

        function resizeTextToFitGrid() {
            var cellTexts = document.querySelectorAll('.cell-text');
            cellTexts.forEach(function (cellText) {
                var cell = cellText.closest('.cell');
                var cellGame = cell.querySelector('.cell-game');
                var cellWidth = cell.offsetWidth;
                var cellHeight = cell.offsetHeight;
                var fontSize = 100;
                var textWidth, textHeight;

                do {
                    cellText.style.fontSize = fontSize + '%';
                    cellGame.style.fontSize = Math.max(Math.floor(fontSize * 0.5), 1) + '%';
                    textWidth = cellText.offsetWidth;
                    textHeight = cellText.offsetHeight;
                    fontSize -= 1;
                } while ((textWidth > cellWidth || textHeight > cellHeight * 0.9) && fontSize > 0);
            });
        }

        window.addEventListener('resize', function () {
            resizeTextToFitGrid();
        });

        function onMouseIn(event) {
            let tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = event.currentTarget.dataset.tooltip.replace(/\n/g, '<br />');
            tooltip.style.left = "0px";
            tooltip.style.top = "0px";

            let newX = event.clientX + 15;
            let newY = event.clientY + 30;
            let vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
            let vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);

            if (newX + tooltip.offsetWidth > vw) {
                newX = Math.max(0, vw - tooltip.offsetWidth);
            }
            if (newY + tooltip.offsetHeight > vh) {
                newY = Math.max(0, event.clientY - tooltip.offsetHeight - 15);
            }

            tooltip.style.left = newX + "px";
            tooltip.style.top = newY + "px";

            tooltip.classList.add('show');
        }

        function onMouseOut(event) {
            let tooltip = document.getElementById('tooltip');
            tooltip.classList.remove('show');
            tooltip.innerHTML = "";
        }

        for (let cellInfo of document.querySelectorAll('.cell-info')) {
            cellInfo.addEventListener('mousemove', onMouseIn);
            cellInfo.addEventListener('mouseout', onMouseOut);
        }

        for (let cellPassword of document.querySelectorAll('.cell-password')) {
            cellPassword.addEventListener('mousemove', onMouseIn);
            cellPassword.addEventListener('mouseout', onMouseOut);
        }

        window.addEventListener('DOMContentLoaded', function () {
            fetch('data.json?' + new Date().getTime())
                .then(response => response.json())
                .then(d => {
                    data = d;
                    let indexes = queryParams.get('id').split(',').map(function (item) {
                        return parseInt(item);
                    });
                    let showGames = false;
                    let previousGame = null;
                    for (let i = 0; i < indexes.length; i++) {
                        let goal = data[indexes[i]];
                        let cell = document.getElementById('cell_' + Math.floor(i / 5) + '_' + i % 5)
                        if (goal.diff > 0) {
                            cell.classList.add('diff' + goal.diff);
                        }

                        let cellText = cell.querySelector(".cell-text");
                        cellText.innerHTML = goal.name;

                        let cellGame = cell.querySelector(".cell-game");
                        cellGame.innerHTML = "MM" + goal.games.join(',');
                        if (!showGames && previousGame != null && previousGame != cellGame.innerHTML) {
                            showGames = true;
                        }
                        if (previousGame == null) {
                            previousGame = cellGame.innerHTML;
                        }

                        let cellInfo = cell.querySelector(".cell-info");
                        if (goal.notes != undefined) {
                            cellInfo.innerHTML = "<img src='img/info.png'/>";
                            cellInfo.dataset.tooltip = goal.notes.replace(/[“”]/g, '"').replace(/[‘’]/g, "'");
                        }

                        let cellPassword = cell.querySelector(".cell-password");
                        if (goal.password != undefined) {
                            cellPassword.innerHTML = "<img src='img/pw.png'/>";
                            cellPassword.dataset.tooltip = "允许使用城堡1存档/密码"
                        }
                    }
                    if (!showGames) {
                        for (let cellGame of document.querySelectorAll('.cell-game')) {
                            cellGame.style.display = 'none';
                        }
                    }
                    resizeTextToFitGrid();
                });
        });
    </script>
</body>

</html>