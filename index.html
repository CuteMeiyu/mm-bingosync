<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>洛克人Bingo工具</title>
    <style>
        .missing {
            border: 1px solid red;
        }
    </style>
</head>

<body>
    <label for="games">游戏编号</label>
    <input type="text" id="games" value="9,10" title="多代用逗号隔开。洛与弗的编号为RF。目前只做了9和10代（"><br>
    <label for="diffs">版面难度</label>
    <input type="text" id="diffs" value="1,2" title="每条线的任务难度星级。最低0星，最高3星。比如：1,1,2表示每条线各有两个1星任务和一个2星任务，其余的都是0星。"><br>
    <label for="seed">随机种子</label>
    <input type="number" id="seed" title="决定生成结果。默认随机。">
    <button onclick="rollSeed()">重投</button><br>
    <label for="balance-games">平衡多代</label>
    <input type="checkbox" id="balance-games" title="让版面上的每代游戏的数量尽可能相等"><br>
    <label for="center-hardest">中心最难</label>
    <input type="checkbox" id="center-hardest" title="把最难的任务放到中心"><br>
    <br>

    <label for="color">玩家颜色</label>
    <input type="color" id="color" name="color"><br>
    <label for="room-name">房间名</label>
    <input type="text" id="room-name"><br>
    <button onclick="createOrJoinRoom()">创建/加入房间</button><br>
    <a id="share-link" href=""></a><br>

    <script>
        var data;
        var randomSeed = Date.now();
        var previousGoalList = [];
        const queryParams = new URLSearchParams(window.location.search);

        document.addEventListener('DOMContentLoaded', function () {
            fetch('data.json?' + new Date().getTime())
                .then(response => response.json())
                .then(d => {
                    data = d;
                    for (let i = 0; i < data.length; i++) {
                        let item = data[i];
                        item.index = i;
                        if (item.groups === undefined) {
                            item.groups = [];
                        }
                        if (item.diff === undefined) {
                            item.diff = 0;
                        }
                    }

                    for (let [key, value] of queryParams) {
                        key = key.toLowerCase();
                        element = document.getElementById(key);
                        if (!element) {
                            continue;
                        }
                        if (element.type == "checkbox") {
                            element.checked = true;
                            continue;
                        }
                        if (element.id != "room-name") {
                            value = value.toUpperCase();
                        }
                        element.value = value;
                    }

                    let seed = document.getElementById("seed");
                    if (seed.value.length == 0) {
                        rollSeed();
                    }
                });
        });

        for (let input of document.getElementsByTagName("input")) {
            if (input.type == "color") {
                continue;
            }
            input.addEventListener("input", onInput);
        }

        function onInput(event) {
            let target;
            if (event === undefined) {
                target = document.getElementById("seed");
            } else {
                target = event.target;
            }
            target.classList.remove("missing");

            let shareLink = document.getElementById("share-link");
            let query = "?";
            for (let input of document.getElementsByTagName("input")) {
                if (input.type == "color") {
                    continue;
                }
                if (input.type == "checkbox") {
                    if (input.checked) {
                        query += input.id + "&";
                    }
                    continue;
                }
                if (input.value.length > 0) {
                    query += input.id + "=" + input.value + "&";
                }
            }
            query = query.substring(0, query.length - 1);
            shareLink.href = window.location.origin + window.location.pathname + query;
            shareLink.innerHTML = shareLink.href.replace(/&/g, "&amp;");
        }

        function random() {
            const a = 1664525;
            const c = 1013904223;
            const m = Math.pow(2, 32);
            randomSeed = (a * randomSeed + c) % m;
            return randomSeed / m;
        }

        function rollSeed() {
            let seed = document.getElementById("seed");
            seed.value = Math.floor(Math.random() * 1000000).toString();
            randomSeed = parseInt(seed.value);
            onInput();
        }

        function swapRows(matrix, row1, row2) {
            let temp = matrix[row1];
            matrix[row1] = matrix[row2];
            matrix[row2] = temp;
        }

        function swapColumns(matrix, col1, col2) {
            for (let i = 0; i < matrix.length; i++) {
                let temp = matrix[i][col1];
                matrix[i][col1] = matrix[i][col2];
                matrix[i][col2] = temp;
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // A是B的子集
        function isSubset(setA, setB) {
            for (let elem of setA) {
                if (setB.indexOf(elem) < 0) {
                    return false;
                }
            }
            return true;
        }

        function generateDiffMatrix(diffs, centerHardest) {
            let diffMatrix;
            if (random() < 0.5) {
                diffMatrix = [
                    [3, 1, 2, 0, 4],
                    [0, 4, 3, 1, 2],
                    [1, 2, 0, 4, 3],
                    [4, 3, 1, 2, 0],
                    [2, 0, 4, 3, 1]
                ];
            } else {
                diffMatrix = [
                    [1, 0, 2, 3, 4],
                    [0, 3, 4, 2, 1],
                    [4, 2, 0, 1, 3],
                    [2, 1, 3, 4, 0],
                    [3, 4, 1, 0, 2]
                ]
            }
            if (random() < 0.5) {
                swapRows(diffMatrix, 0, 4);
                swapRows(diffMatrix, 1, 3);
            }

            for (let i = 0; diffs.length < 5; i++) { diffs.push(0); }
            shuffleArray(diffs);
            if (centerHardest) {
                argmax = diffs.indexOf(Math.max(...diffs));
                temp = diffs[0];
                diffs[0] = diffs[argmax];
                diffs[argmax] = temp;
            }

            if (random() < 0.5) {
                swapRows(diffMatrix, 0, 4);
                swapColumns(diffMatrix, 0, 4);
            }

            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    diffMatrix[row][col] = diffs[diffMatrix[row][col]];
                }
            }
            return diffMatrix
        }

        function generateGoalList(diffMatrix, games, balanceGames) {
            let goalList = [];
            let goals = [...data];
            shuffleArray(goals);
            let indexUsed = [];
            let groupUsed = [];
            let gamesCount = {};
            for (let game of games) {
                gamesCount[game] = 0;
            }
            let leniency = 0;
            let changed = false;
            let i = -1;
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    while (true) {
                        i += 1;
                        if (i >= goals.length) {
                            if (!changed) {
                                leniency += 1;
                                if (leniency > 1) {
                                    throw new Error("没有足够数量的符合条件的任务");
                                }
                            }
                            changed = false;
                            i = 0;
                        }
                        if (indexUsed.indexOf(i) >= 0) {
                            continue;
                        }
                        let goal = goals[i];
                        if (leniency < 1 && goal.groups.length > 0 && isSubset(goal.groups, groupUsed)) {
                            continue;
                        }
                        if (goal.diff != diffMatrix[row][col]) {
                            continue;
                        }
                        if (!isSubset(goal.games, games)) {
                            continue;
                        }
                        if (balanceGames) {
                            for (let game of goal.games) {
                                gamesCount[game] += 1;
                            }
                            gamesCountValues = Object.values(gamesCount)
                            if (Math.max(...gamesCountValues) - Math.min(...gamesCountValues) > 1) {
                                for (let game of goal.games) {
                                    gamesCount[game] -= 1;
                                }
                                continue;
                            }
                        }
                        indexUsed.push(i);
                        groupUsed = groupUsed.concat(goal.groups);
                        changed = true;
                        goalList.push(goal);
                        break;
                    }
                }
            }
            return goalList
        }

        const regularFuncs = {
            "games": function (x) { return x.value.split(/[,，]\s*/); },
            "diffs": function (x) { return x.value.split(/[,，]\s*/).map(function (item) { return parseInt(item); }); },
            "seed": function (x) { return parseInt(x.value); },
            "balance-games": function (x) { return x.checked; },
            "center-hardest": function (x) { return x.checked; },
            "room-name": function (x) { return x.value; },
            "color": function (x) { return x.value; }
        };

        function parseSettings() {
            let settings = {};
            for (let [setting, regularFunc] of regularFuncs) {
                let element = document.getElementById(setting);
                
            }
        }

        function generateBoard() {
            let settings = parseSettings();
            shuffleArray(settings.diffs);
            let diffMatrix = generateDiffMatrix(settings.diffs, settings.centerHardest);
            let goalList;
            try {
                goalList = generateGoalList(diffMatrix, settings.games, settings.balanceGames);
            } catch (error) {
                document.getElementById("result-box").value = error.message;
                return;
            }
            previousGoalList = goalList;

            let showGames = settings.games.length > 1;
            let bingosyncGoalList = convertBingosyncGoalList(goalList, showGames);
            document.getElementById("result-box").value = JSON.stringify(bingosyncGoalList, null, 2);
        }

        function createOrJoinRoom() {
            if (previousGoalList.length == 0) {
                return;
            }
            params = "?id=" + previousGoalList.map(function (goal) {
                return goal.index;
            }).join(",");
            window.open('popup.html' + params, 'Bingo', 'width=780,height=650');
        }
    </script>
</body>

</html>