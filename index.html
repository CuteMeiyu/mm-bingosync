<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>洛克人Bingo工具</title>
</head>

<body>
    <label for="games">游戏编号</label>
    <input type="text" id="games" value="9,10" title="多代用逗号隔开。洛与弗的编号为RF。目前只做了9和10代（"><br>
    <label for="diffs">版面难度</label>
    <input type="text" id="diffs" value="1,2" title="每条线的任务难度星级。最低0星，最高3星。比如：1,1,2表示每条线各有两个1星任务和一个2星任务，其余的都是0星。"><br>
    <label for="seed">随机种子</label>
    <input type="number" id="seed" title="决定生成结果。默认随机。">
    <input type="checkbox" id="lock-seed" title="让每次生成的结果相同"><label for="lock-seed">固定</label><br>
    <label for="balance-games">平衡多代</label>
    <input type="checkbox" id="balance-games" title="让版面上的每代游戏的数量尽可能相等" checked><br>
    <label for="center-hardest">中心最难</label>
    <input type="checkbox" id="center-hardest" title="把最难的任务放到中心"><br>
    <label for="show-notes">显示备注</label>
    <input type="checkbox" id="show-notes" title="在Bingosync任务名末尾添加一个括号内短备注"><br>
    <button id="generate-board-btn" onclick="generateBoard()">生成</button>
    <br>

    <textarea id="result-box" rows="10" cols="50" readonly></textarea><br>
    <button onclick="copyResult()">复制</button>
    <button onclick="popup()">弹出</button><br>
    <a href="https://bingosync.com/" target="_blank">Bingosync</a><br>
    <a href="https://revned77.github.io/" target="_blank">地图</a><br>

    <script>
        var data;
        var randomSeed = Date.now();
        var previousGoalList = [];
        const queryParams = new URLSearchParams(window.location.search);

        document.addEventListener('DOMContentLoaded', function () {
            fetch('data.json')
                .then(response => response.json())
                .then(d => {
                    data = d;
                    for (let i = 0; i < data.length; i++) {
                        let item = data[i];
                        item.index = i;
                        if (item.groups === undefined) {
                            item.groups = [];
                        }
                        if (item.diff === undefined) {
                            item.diff = 0;
                        }
                    }
                });
            for (let [key, value] of queryParams) {
                key = key.toLowerCase();
                element = document.getElementById(key);
                if (!element || value.length == 0) {
                    continue;
                }
                value = value.toUpperCase();
                if (value == "T") {
                    element.checked = true;
                    continue;
                }
                if (value == "F") {
                    element.checked = false;
                    continue;
                }
                element.value = value;
            }
        });

        function copyResult() {
            var copyText = document.getElementById("result-box");
            copyText.select();
            document.execCommand("copy");
        }

        function random() {
            const a = 1664525;
            const c = 1013904223;
            const m = Math.pow(2, 32);
            randomSeed = (a * randomSeed + c) % m;
            return randomSeed / m;
        }

        function swapRows(matrix, row1, row2) {
            let temp = matrix[row1];
            matrix[row1] = matrix[row2];
            matrix[row2] = temp;
        }

        function swapColumns(matrix, col1, col2) {
            for (let i = 0; i < matrix.length; i++) {
                let temp = matrix[i][col1];
                matrix[i][col1] = matrix[i][col2];
                matrix[i][col2] = temp;
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // A是B的子集
        function isSubset(setA, setB) {
            for (let elem of setA) {
                if (setB.indexOf(elem) < 0) {
                    return false;
                }
            }
            return true;
        }

        function updateSeed() {
            let seed = document.getElementById("seed");
            if (seed.value.length == 0 || !document.getElementById("lock-seed").checked) {
                seed.value = Math.floor(Math.random() * 1000000).toString();
            }
            randomSeed = parseInt(seed.value);
        }

        function parseSettings() {
            return {
                games: document.getElementById("games").value.split(/[,，]\s*/),
                diffs: document.getElementById("diffs").value.split(/[,，]\s*/).map(function (item) {
                    return parseInt(item);
                }),
                balanceGames: document.getElementById("balance-games").checked,
                centerHardest: document.getElementById("center-hardest").checked,
                showNotes: document.getElementById("show-notes").checked
            }
        }

        function generateDiffMatrix(diffs, centerHardest) {
            let diffMatrix = [];
            for (let i = 0; i < 5; i++) {
                diffMatrix[i] = [];
                for (let j = 0; j < 5; j++) {
                    diffMatrix[i][j] = 0;
                }
            };
            let step = 1 + Math.floor(random() * 4);
            let offset;
            if (centerHardest) {
                offset = 8 - step * diffs.indexOf(Math.max(...diffs));
            } else {
                offset = Math.floor(random() * 5);
            }
            let col = offset % 5;
            for (let row = 0; row < 5; row++) {
                for (let i = 0; i < diffs.length; i++) {
                    diffMatrix[row][(col + i * step) % 5] = diffs[i];
                }
                col = (col + 2) % 5;
            }
            if (random() < 0.5) {
                swapRows(diffMatrix, 0, 4);
                swapColumns(diffMatrix, 0, 4);
            }
            if (random() < 0.5) {
                swapRows(diffMatrix, 1, 3);
                swapColumns(diffMatrix, 1, 3);
            }
            return diffMatrix
        }

        function generateGoalList(diffMatrix, games, balanceGames) {
            let goalList = [];
            let goals = [...data];
            shuffleArray(goals);
            let indexUsed = [];
            let groupUsed = [];
            let gamesCount = {};
            for (let game of games) {
                gamesCount[game] = 0;
            }
            let leniency = 0;
            let changed = false;
            let i = -1;
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    while (true) {
                        i += 1;
                        if (i >= goals.length) {
                            if (!changed) {
                                leniency += 1;
                                if (leniency > 1) {
                                    throw new Error("没有足够数量的符合条件的任务");
                                }
                            }
                            changed = false;
                            i = 0;
                        }
                        if (indexUsed.indexOf(i) >= 0) {
                            continue;
                        }
                        let goal = goals[i];
                        if (leniency < 1 && goal.groups.length > 0 && isSubset(goal.groups, groupUsed)) {
                            continue;
                        }
                        if (goal.diff != diffMatrix[row][col]) {
                            continue;
                        }
                        if (!isSubset(goal.games, games)) {
                            continue;
                        }
                        if (balanceGames) {
                            for (let game of goal.games) {
                                gamesCount[game] += 1;
                            }
                            gamesCountValues = Object.values(gamesCount)
                            if (Math.max(...gamesCountValues) - Math.min(...gamesCountValues) > 1) {
                                for (let game of goal.games) {
                                    gamesCount[game] -= 1;
                                }
                                continue;
                            }
                        }
                        indexUsed.push(i);
                        groupUsed = groupUsed.concat(goal.groups);
                        changed = true;
                        goalList.push(goal);
                        break;
                    }
                }
            }
            return goalList
        }

        function convertBingosyncGoalList(goalList, showGames, showNotes) {
            let bingosyncGoalList = []
            for (goal of goalList) {
                let name = "*".repeat(goal.diff) + goal.name;
                if (goal.short_notes != undefined && showNotes) {
                    name += "(" + goal.short_notes + ")";
                }
                name = name.replace(/[,，。]/g, " ");
                if (showGames) {
                    name += "[" + goal.games.join(",");
                }
                if (goal.password != undefined) {
                    name += "#";
                }
                name += "]";
                bingosyncGoalList.push({ name: name });
            }
            return bingosyncGoalList
        }

        function generateBoard() {
            updateSeed();
            let settings = parseSettings();
            shuffleArray(settings.diffs);
            let diffMatrix = generateDiffMatrix(settings.diffs, settings.centerHardest);
            let goalList;
            try {
                goalList = generateGoalList(diffMatrix, settings.games, settings.balanceGames);
            } catch (error) {
                document.getElementById("result-box").value = error.message;
                return;
            }
            previousGoalList = goalList;

            let showGames = settings.games.length > 1;
            let bingosyncGoalList = convertBingosyncGoalList(goalList, showGames, settings.showNotes);
            document.getElementById("result-box").value = JSON.stringify(bingosyncGoalList, null, 2);
        }

        function popup() {
            if (previousGoalList.length == 0) {
                return;
            }
            params = "?id=" + previousGoalList.map(function (goal) {
                return goal.index;
            }).join(",");
            window.open('popup.html' + params, 'Bingo', 'width=780,height=650');
        }
    </script>
</body>

</html>